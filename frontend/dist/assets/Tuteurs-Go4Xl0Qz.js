import{_ as O,c as p,o as f,b as t,e as W,i as I,t as c,l as X,h as y,v as w,m as Y,F as B,j as F,u as Z,f as i,q as Q,p as $,g as ee,s as q,R as G}from"./index-C-Ksv_Lv.js";const te={name:"Tuteurs",setup(){const x=Z(),e=i([]),z=i([]),r=i(!1),V=i(!1),k=i(null),h=i(null),S=i(!1),D=i(""),n=i(""),v=i(""),b=i(""),s=i({id:null,nomStructure:"",sigle:""}),g=Q(()=>{var a;const o=(a=x.state.user)==null?void 0:a.structureId;return console.log("Structure ID:",o),o}),u=i({nom:"",prenom:"",email:"",telephone:"",password:"",role:"tuteur",structureId:null,sousStructureId:""});$(g,o=>{o&&(u.value.structureId=o)},{immediate:!0});const C=async()=>{try{const o=await G.getSousStructures();z.value=o.filter(m=>m.parentId===x.state.user.structureId);const l=(await G.getStructures()).find(m=>m.id===x.state.user.structureId);l&&(s.value={id:l.id,nomStructure:l.nomStructure,sigle:l.sigle},u.value.structureId=l.id)}catch(o){console.error("Erreur lors de la récupération des sous-structures:",o),n.value="Erreur lors de la récupération des sous-structures"}},T=Q(()=>{if(!D.value)return e.value;const o=D.value.toLowerCase();return e.value.filter(a=>{var d,E,_,N,R;const l=`${(E=(d=a.user)==null?void 0:d.profile)==null?void 0:E.nom} ${(N=(_=a.user)==null?void 0:_.profile)==null?void 0:N.prenom}`.toLowerCase(),m=(R=a.user)==null?void 0:R.email.toLowerCase();return l.includes(o)||m.includes(o)})}),M=o=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o),U=async()=>{var o,a,l,m;try{if(n.value="",v.value="",b.value="",!M(u.value.email)){v.value="Veuillez entrer une adresse email valide";return}if(u.value.password.length<6){b.value="Le mot de passe doit contenir au moins 6 caractères";return}if(!g.value){n.value="ID de structure non disponible. Veuillez vous reconnecter.";return}if(!u.value.sousStructureId){n.value="Veuillez sélectionner une sous-structure";return}const d={...u.value,structureId:g.value,role:"tuteur"};console.log("Données envoyées:",d),await q.createTuteur(d),x.dispatch("setSuccess","Agent ajouté avec succès"),u.value={nom:"",prenom:"",email:"",telephone:"",password:"",role:"tuteur",structureId:g.value,sousStructureId:""},r.value=!1,await j()}catch(d){console.error("Erreur lors de la création de l'agent:",d),((o=d.response)==null?void 0:o.status)===409?v.value="Un utilisateur avec cet email existe déjà":((a=d.response)==null?void 0:a.status)===400?n.value=d.response.data.message||"Données invalides":n.value=((m=(l=d.response)==null?void 0:l.data)==null?void 0:m.message)||"Une erreur est survenue lors de la création de l'agent"}},A=()=>{r.value=!1,S.value=!1,h.value=null,L()},L=()=>{u.value={nom:"",prenom:"",email:"",telephone:"",password:"",role:"tuteur",structureId:g.value,sousStructureId:""},n.value="",v.value="",b.value=""},P=o=>{S.value=!0,h.value=o,u.value={nom:o.user.profile.nom,prenom:o.user.profile.prenom,email:o.user.email,telephone:o.user.profile.telephone||"",structureId:g.value,sousStructureId:o.structureId,role:"tuteur"},r.value=!0},H=async()=>{var o,a;try{if(n.value="",v.value="",b.value="",!M(u.value.email)){v.value="Veuillez entrer une adresse email valide";return}if(!u.value.sousStructureId){n.value="Veuillez sélectionner une sous-structure";return}const l={...u.value,structureId:u.value.sousStructureId};await q.updateTuteur(h.value.id,l),x.dispatch("setSuccess","Agent modifié avec succès"),A(),await j()}catch(l){console.error("Erreur lors de la modification de l'agent:",l),n.value=((a=(o=l.response)==null?void 0:o.data)==null?void 0:a.message)||"Une erreur est survenue lors de la modification de l'agent"}},J=o=>{k.value=o,V.value=!0},K=async()=>{var o,a;try{await q.deleteTuteur(k.value.id),x.dispatch("setSuccess","Agent supprimé avec succès"),V.value=!1,k.value=null,await j()}catch(l){console.error("Erreur lors de la suppression de l'agent:",l),n.value=((a=(o=l.response)==null?void 0:o.data)==null?void 0:a.message)||"Erreur lors de la suppression de l'agent"}},j=async()=>{var o,a;try{const l=await q.getTuteurs();e.value=l.filter(m=>{var E,_;return((E=m.structure)==null?void 0:E.parentId)===x.state.user.structureId&&((_=m.user)==null?void 0:_.role)==="tuteur"}),console.log("Agents filtrés:",e.value)}catch(l){console.error("Erreur lors de la récupération des agents:",l),n.value=((a=(o=l.response)==null?void 0:o.data)==null?void 0:a.message)||"Erreur lors de la récupération des agents"}};return ee(()=>{j(),C()}),{agents:e,sousStructures:z,showAddModal:r,showDeleteModal:V,agentToDelete:k,agentToEdit:h,editMode:S,searchQuery:D,formData:u,errorMessage:n,emailError:v,passwordError:b,filteredAgents:T,createAgent:U,updateAgent:H,deleteAgent:J,confirmDelete:K,editAgent:P,closeModal:A,userStructure:s}}},re={class:"min-h-screen bg-gray-100"},se={class:"flex-1"},oe={class:"bg-primary shadow"},le={class:"px-4 py-4 flex justify-between items-center"},ae={class:"p-6"},ue={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},ne={class:"bg-white rounded-lg w-full max-w-md p-6"},ie={class:"flex justify-between items-center mb-4"},de={class:"text-xl font-semibold"},ce={key:0,class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"},me={class:"grid grid-cols-2 gap-4"},pe={key:0,class:"text-red-500 text-sm mt-1"},fe={class:"relative"},ve=["value"],ge={key:1},ye=["required"],xe={key:0,class:"text-red-500 text-sm mt-1"},be={class:"flex justify-end space-x-3"},we={type:"submit",class:"px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark"},he={key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},Se={class:"bg-white rounded-lg w-full max-w-md p-6"},De={class:"text-center"},Ie={class:"text-gray-600 mb-6"},ke={class:"flex justify-end space-x-3"},Me={class:"bg-white shadow rounded-lg"},Ae={class:"p-4 border-b border-gray-200"},Ee={class:"relative"},_e={class:"overflow-x-auto"},Ve={class:"min-w-full divide-y divide-gray-200"},Ce={class:"bg-white divide-y divide-gray-200"},Te={class:"px-6 py-4"},Ue={class:"px-6 py-4"},je={class:"px-6 py-4"},qe={class:"px-6 py-4"},ze=["onClick"],Le=["onClick"];function Ne(x,e,z,r,V,k){var h,S,D,n,v,b;return f(),p("div",re,[t("div",se,[t("header",oe,[t("div",le,[e[16]||(e[16]=t("h1",{class:"text-2xl font-bold text-white"},"Gestion des agents",-1)),t("button",{onClick:e[0]||(e[0]=s=>r.showAddModal=!0),class:"bg-white text-primary px-4 py-2 rounded hover:bg-gray-100"},e[15]||(e[15]=[t("i",{class:"fas fa-plus mr-2"},null,-1),W(" Ajouter un agent ")]))])]),t("main",ae,[r.showAddModal?(f(),p("div",ue,[t("div",ne,[t("div",ie,[t("h2",de,c(r.editMode?"Modifier":"Ajouter")+" un agent",1),t("button",{onClick:e[1]||(e[1]=(...s)=>r.closeModal&&r.closeModal(...s)),class:"text-gray-500 hover:text-gray-700"},e[17]||(e[17]=[t("i",{class:"fas fa-times"},null,-1)]))]),t("form",{onSubmit:e[11]||(e[11]=X(s=>r.editMode?r.updateAgent():r.createAgent(),["prevent"])),class:"space-y-4"},[r.errorMessage?(f(),p("div",ce,c(r.errorMessage),1)):I("",!0),t("div",me,[t("div",null,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-gray-700"},"Nom",-1)),y(t("input",{type:"text","onUpdate:modelValue":e[2]||(e[2]=s=>r.formData.nom=s),required:"",class:"mt-1 input-field"},null,512),[[w,r.formData.nom]])]),t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm font-medium text-gray-700"},"Prénom",-1)),y(t("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=s=>r.formData.prenom=s),required:"",class:"mt-1 input-field"},null,512),[[w,r.formData.prenom]])])]),t("div",null,[e[20]||(e[20]=t("label",{class:"block text-sm font-medium text-gray-700"},"Email",-1)),y(t("input",{type:"email","onUpdate:modelValue":e[4]||(e[4]=s=>r.formData.email=s),required:"",class:"mt-1 input-field"},null,512),[[w,r.formData.email]]),r.emailError?(f(),p("p",pe,c(r.emailError),1)):I("",!0)]),t("div",null,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-gray-700"},"Téléphone",-1)),y(t("input",{type:"tel","onUpdate:modelValue":e[5]||(e[5]=s=>r.formData.telephone=s),required:"",class:"mt-1 input-field"},null,512),[[w,r.formData.telephone]])]),t("div",null,[e[22]||(e[22]=t("label",{class:"block text-sm font-medium text-gray-700"},"Structure parente",-1)),t("div",fe,[y(t("input",{type:"text","onUpdate:modelValue":e[6]||(e[6]=s=>r.userStructure.nomStructure=s),disabled:"",class:"mt-1 input-field bg-gray-100"},null,512),[[w,r.userStructure.nomStructure]]),y(t("input",{type:"hidden","onUpdate:modelValue":e[7]||(e[7]=s=>r.formData.structureId=s)},null,512),[[w,r.formData.structureId]])])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-gray-700"},"Sous-structure",-1)),y(t("select",{"onUpdate:modelValue":e[8]||(e[8]=s=>r.formData.sousStructureId=s),required:"",class:"mt-1 input-field"},[e[23]||(e[23]=t("option",{value:""},"Sélectionner une sous-structure",-1)),(f(!0),p(B,null,F(r.sousStructures,s=>(f(),p("option",{key:s.id,value:s.id},c(s.nomStructure),9,ve))),128))],512),[[Y,r.formData.sousStructureId]])]),r.editMode?I("",!0):(f(),p("div",ge,[e[25]||(e[25]=t("label",{class:"block text-sm font-medium text-gray-700"},"Mot de passe",-1)),y(t("input",{type:"password","onUpdate:modelValue":e[9]||(e[9]=s=>r.formData.password=s),required:!r.editMode,class:"mt-1 input-field"},null,8,ye),[[w,r.formData.password]]),r.passwordError?(f(),p("p",xe,c(r.passwordError),1)):I("",!0)])),t("div",be,[t("button",{type:"button",onClick:e[10]||(e[10]=(...s)=>r.closeModal&&r.closeModal(...s)),class:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"}," Annuler "),t("button",we,c(r.editMode?"Modifier":"Créer")+" l'agent ",1)])],32)])])):I("",!0),r.showDeleteModal?(f(),p("div",he,[t("div",Se,[t("div",De,[e[26]||(e[26]=t("i",{class:"fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"},null,-1)),e[27]||(e[27]=t("h3",{class:"text-lg font-semibold mb-2"},"Confirmer la suppression",-1)),t("p",Ie,` Êtes-vous sûr de vouloir supprimer l'agent "`+c((D=(S=(h=r.agentToDelete)==null?void 0:h.user)==null?void 0:S.profile)==null?void 0:D.nom)+" "+c((b=(v=(n=r.agentToDelete)==null?void 0:n.user)==null?void 0:v.profile)==null?void 0:b.prenom)+'" ? Cette action est irréversible. ',1)]),t("div",ke,[t("button",{onClick:e[12]||(e[12]=s=>r.showDeleteModal=!1),class:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"}," Annuler "),t("button",{onClick:e[13]||(e[13]=(...s)=>r.confirmDelete&&r.confirmDelete(...s)),class:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"}," Supprimer ")])])])):I("",!0),t("div",Me,[t("div",Ae,[t("div",Ee,[y(t("input",{type:"text","onUpdate:modelValue":e[14]||(e[14]=s=>r.searchQuery=s),placeholder:"Rechercher un agent...",class:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"},null,512),[[w,r.searchQuery]]),e[28]||(e[28]=t("i",{class:"fas fa-search absolute right-3 top-3 text-gray-400"},null,-1))])]),t("div",_e,[t("table",Ve,[e[31]||(e[31]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Nom"),t("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Email"),t("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Téléphone"),t("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Actions")])],-1)),t("tbody",Ce,[(f(!0),p(B,null,F(r.filteredAgents,s=>{var g,u,C,T,M,U,A;return f(),p("tr",{key:s.id},[t("td",Te,c((u=(g=s.user)==null?void 0:g.profile)==null?void 0:u.nom)+" "+c((T=(C=s.user)==null?void 0:C.profile)==null?void 0:T.prenom),1),t("td",Ue,c((M=s.user)==null?void 0:M.email),1),t("td",je,c((A=(U=s.user)==null?void 0:U.profile)==null?void 0:A.telephone),1),t("td",qe,[t("button",{onClick:L=>r.editAgent(s),class:"text-primary hover:text-primary-dark mr-3"},e[29]||(e[29]=[t("i",{class:"fas fa-edit"},null,-1)]),8,ze),t("button",{onClick:L=>r.deleteAgent(s),class:"text-red-600 hover:text-red-900"},e[30]||(e[30]=[t("i",{class:"fas fa-trash"},null,-1)]),8,Le)])])}),128))])])])])])])])}const Be=O(te,[["render",Ne],["__scopeId","data-v-3fb3508e"]]);export{Be as default};
