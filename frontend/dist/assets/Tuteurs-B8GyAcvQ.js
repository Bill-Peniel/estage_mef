import{_ as ne,c as p,o as v,b as e,i as P,e as ie,h as M,v as V,F as Q,j as G,t as d,l as de,m as X,n as Y,u as ce,f as y,p as me,q as L,g as pe,s as j}from"./index-C-Ksv_Lv.js";const ve={name:"Tuteurs",setup(){const h=ce(),t=y(!1),U=y(!1),s=y([]),R=y(""),A=y(""),r=y(!1),g=y([]),c=y(""),x=y(""),b=y(""),k=y(1),_=20,T=y(null);me(R,()=>{k.value=1});const w=L(()=>{const o=R.value.toLowerCase();return s.value.filter(l=>{var S,D,z,q,O,F,N,i,C,f,B;const u=`${(D=(S=l.user)==null?void 0:S.profile)==null?void 0:D.nom} ${(q=(z=l.user)==null?void 0:z.profile)==null?void 0:q.prenom}`.toLowerCase(),n=((F=(O=l.user)==null?void 0:O.email)==null?void 0:F.toLowerCase())||"",m=((C=(i=(N=l.user)==null?void 0:N.profile)==null?void 0:i.telephone)==null?void 0:C.toLowerCase())||"",I=((B=(f=l.structure)==null?void 0:f.nomStructure)==null?void 0:B.toLowerCase())||"";return u.includes(o)||n.includes(o)||m.includes(o)||I.includes(o)})}),E=L(()=>Math.ceil(w.value.length/_)),J=L(()=>(k.value-1)*_),H=L(()=>{const o=J.value+_;return o>w.value.length?w.value.length:o}),Z=L(()=>w.value.slice(J.value,H.value)),$=L(()=>{const o=[];if(E.value<=5)for(let u=1;u<=E.value;u++)o.push(u);else{let u=Math.max(1,k.value-Math.floor(2.5)),n=u+5-1;n>E.value&&(n=E.value,u=Math.max(1,n-5+1));for(let m=u;m<=n;m++)o.push(m)}return o}),a=y({nom:"",prenom:"",sexe:"",telephone:"",structureId:"",sousStructureId:"",email:"",password:"",role:"agent"}),ee=L(()=>{const o=A.value.toLowerCase();return g.value.filter(l=>!l.isDeleted).filter(l=>l.nomStructure.toLowerCase().includes(o))}),te=o=>{a.value.structureId=o.id,A.value=o.nomStructure,T.value=o,a.value.sousStructureId="",r.value=!1};pe(async()=>{var o,l;try{const[u,n]=await Promise.all([j.getTuteurs(),j.getStructures()]);console.log("Tous les tuteurs reçus:",u),console.log("Rôle de l'utilisateur connecté:",(o=h.state.user)==null?void 0:o.role),((l=h.state.user)==null?void 0:l.role)==="admin"?(s.value=u.filter(m=>{var I,S,D;return console.log("Tuteur:",(I=m.user)==null?void 0:I.role,(S=m.user)==null?void 0:S.email),((D=m.user)==null?void 0:D.role)==="structure"}),console.log("Tuteurs filtrés pour admin:",s.value)):s.value=u,g.value=n.filter(m=>!m.isDeleted)}catch(u){console.error("Erreur lors du chargement des données:",u),h.dispatch("setError","Erreur lors du chargement des données")}});const K=o=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o),se=()=>{if(x.value="",!a.value.email){x.value="L'email est requis";return}K(a.value.email)||(x.value="Veuillez entrer une adresse email valide")},re=()=>{if(b.value="",!a.value.password){b.value="Le mot de passe est requis";return}a.value.password.length<6&&(b.value="Le mot de passe doit contenir au moins 6 caractères")},oe=async()=>{var o,l,u,n,m,I,S,D,z,q,O,F,N;try{if(!a.value.email||!a.value.password||!a.value.nom||!a.value.prenom){c.value="Veuillez remplir tous les champs obligatoires";return}if(!K(a.value.email)){x.value="Veuillez entrer une adresse email valide";return}if(!a.value.structureId){c.value="Veuillez sélectionner une structure";return}if(a.value.password.length<6){b.value="Le mot de passe doit contenir au moins 6 caractères";return}const i={email:a.value.email,password:a.value.password,nom:a.value.nom,prenom:a.value.prenom,telephone:a.value.telephone,structureId:parseInt(a.value.structureId),role:((o=h.state.user)==null?void 0:o.role)==="admin"?"agent":"tuteur"},C=g.value.find(f=>f.id===parseInt(a.value.structureId));if(console.log("Structure sélectionnée:",C),((l=h.state.user)==null?void 0:l.role)!=="admin"&&((u=C==null?void 0:C.sousStructures)==null?void 0:u.length)>0){if(!a.value.sousStructureId){c.value="Veuillez sélectionner une sous-structure";return}if(!C.sousStructures.find(B=>B.id===parseInt(a.value.sousStructureId))){c.value="La sous-structure sélectionnée n'appartient pas à la structure";return}i.sousStructureId=parseInt(a.value.sousStructureId)}else a.value.sousStructureId&&a.value.sousStructureId!==a.value.structureId?i.sousStructureId=parseInt(a.value.sousStructureId):i.sousStructureId=null;if(console.log("Données envoyées pour création:",JSON.stringify(i,null,2)),U.value)await j.updateTuteur(editingTuteurId.value,i),h.dispatch("setSuccess","Agent modifié avec succès");else try{const f=await j.createTuteur(i);console.log("Réponse de création:",f.data),h.dispatch("setSuccess","Agent ajouté avec succès")}catch(f){if(console.error("Erreur détaillée:",{status:(n=f.response)==null?void 0:n.status,data:(m=f.response)==null?void 0:m.data,message:(S=(I=f.response)==null?void 0:I.data)==null?void 0:S.message,config:f.config}),((D=f.response)==null?void 0:D.status)===409){x.value=f.response.data.message||"Un utilisateur avec cet email existe déjà";return}throw f}await W(),t.value=!1,ue()}catch(i){console.error("Erreur lors de la sauvegarde du tuteur:",i),((z=i.response)==null?void 0:z.status)===409?x.value=i.response.data.message||"Un utilisateur avec cet email existe déjà":((q=i.response)==null?void 0:q.status)===400?c.value=typeof i.response.data.message=="string"?i.response.data.message:Array.isArray(i.response.data.message)?i.response.data.message.join(", "):"Données invalides":((O=i.response)==null?void 0:O.status)===500?c.value="Une erreur est survenue lors de la création du tuteur. Veuillez réessayer.":c.value=((N=(F=i.response)==null?void 0:F.data)==null?void 0:N.message)||"Une erreur est survenue",console.error("Message d'erreur complet:",c.value)}},le=o=>{var l;U.value=!0,a.value={...o},A.value=((l=o.structure)==null?void 0:l.nomStructure)||"",t.value=!0},ae=async o=>{var l,u;if(confirm("Êtes-vous sûr de vouloir supprimer cet agent ?"))try{await j.deleteTuteur(o),s.value=s.value.filter(n=>n.id!==o)}catch(n){console.error("Erreur lors de la suppression du tuteur:",n),c.value=((u=(l=n.response)==null?void 0:l.data)==null?void 0:u.message)||"Erreur lors de la suppression du tuteur"}},ue=()=>{U.value=!1,a.value={nom:"",prenom:"",sexe:"",telephone:"",structureId:"",sousStructureId:"",email:"",password:"",role:"agent"},A.value="",T.value=null,c.value="",x.value="",b.value=""},W=async()=>{var o,l;try{const u=await j.getTuteurs();console.log("Tuteurs reçus lors du rechargement:",u),console.log("Rôle de l'utilisateur connecté:",(o=h.state.user)==null?void 0:o.role),((l=h.state.user)==null?void 0:l.role)==="admin"?(s.value=u.filter(n=>{var m,I,S;return console.log("Tuteur filtré:",(m=n.user)==null?void 0:m.role,(I=n.user)==null?void 0:I.email),((S=n.user)==null?void 0:S.role)==="structure"}),console.log("Tuteurs filtrés pour admin:",s.value)):s.value=u}catch(u){console.error("Erreur lors du chargement des tuteurs:",u),h.dispatch("setError","Erreur lors du chargement des tuteurs")}};return{showAddModal:t,editMode:U,tuteurs:s,filteredTuteurs:w,paginatedTuteurs:Z,searchQuery:R,currentPage:k,totalPages:E,startIndex:J,endIndex:H,displayedPages:$,formData:a,searchStructure:A,showStructuresList:r,structures:g,filteredStructures:ee,selectStructure:te,saveTuteur:oe,editTuteur:le,deleteTuteur:ae,errorMessage:c,emailError:x,passwordError:b,validateEmailOnInput:se,validatePasswordOnInput:re,loadTuteurs:W,selectedStructure:T,fetchStructures:async()=>{try{const o=await api.get("/structures");console.log("Structures reçues:",o.data),g.value=o.data.filter(l=>!l.parentId);for(let l of g.value){const u=o.data.filter(n=>n.parentId===l.id);l.sousStructures=u}console.log("Structures avec sous-structures:",g.value)}catch(o){console.error("Erreur lors du chargement des structures:",o),toast.error("Erreur lors du chargement des structures")}}}}},fe={class:"min-h-screen bg-gray-100 top-10 md:top-16 lg:top-16 relative z-0"},ge={class:"flex-1"},xe={class:"bg-white shadow sticky top-0 z-20"},ye={class:"px-4 py-4 flex flex-col sm:flex-row justify-between items-center gap-2"},be={class:"p-2 sm:p-6"},he={class:"bg-white shadow rounded-lg"},we={class:"p-4 border-b border-gray-200"},Se={class:"relative"},ke={class:"overflow-x-auto hidden md:block"},Ie={class:"min-w-full divide-y divide-gray-200"},_e={class:"bg-white divide-y divide-gray-200"},Te={class:"px-6 py-4 whitespace-nowrap"},Ee={class:"px-6 py-4 break-words"},Me={class:"px-6 py-4 whitespace-nowrap"},De={class:"px-6 py-4 whitespace-nowrap"},Ce={class:"px-6 py-4 whitespace-nowrap text-sm font-medium flex gap-2"},Pe=["onClick"],Ve=["onClick"],Le={key:0},Ae={class:"md:hidden space-y-4 p-2"},je={class:"flex items-center justify-between mb-1"},Ue={class:"font-semibold text-gray-900"},ze={class:"text-xs text-gray-500"},qe={class:"flex items-center text-gray-700 text-sm mb-1"},Oe={class:"flex items-center text-gray-700 text-sm mb-1"},Fe={class:"flex items-center gap-2 mt-2"},Ne=["onClick"],Re=["onClick"],Be={class:"bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200"},Qe=["disabled"],Ge={class:"text-sm text-gray-700"},Je=["disabled"],He={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto"},Ke={class:"relative top-16 bottom-16 bg-white rounded-lg w-full max-w-md my-8 mx-2 sm:mx-auto"},We={class:"px-4 py-3 border-b border-gray-200"},Xe={class:"text-lg font-semibold text-center"},Ye={key:0,class:"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"},Ze={class:"space-y-3"},$e={class:"grid grid-cols-1 gap-3"},et={class:"grid grid-cols-1 gap-3"},tt={class:"relative"},st={key:0,class:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto"},rt=["onClick"],ot={key:0},lt=["value"],at={class:"grid grid-cols-1 gap-3"},ut={key:0,class:"mt-1 text-sm text-red-600"},nt={key:0,class:"mt-1 text-sm text-red-600"},it={class:"mt-4 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-2"},dt={type:"submit",class:"btn-primary w-full sm:w-auto"};function ct(h,t,U,s,R,A){return v(),p("div",fe,[e("div",ge,[e("header",xe,[e("div",ye,[t[18]||(t[18]=e("h1",{class:"text-2xl font-bold text-primary text-center sm:text-left"},"Gestion des agents",-1)),e("button",{onClick:t[0]||(t[0]=r=>s.showAddModal=!0),class:"bg-primary text-white px-4 py-2 rounded hover:bg-green-900 w-full sm:w-auto"},t[17]||(t[17]=[e("i",{class:"fas fa-plus mr-2"},null,-1),ie(" Ajouter un agent ")]))])]),e("main",be,[e("div",he,[e("div",we,[e("div",Se,[M(e("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=r=>s.searchQuery=r),placeholder:"Rechercher un tuteur...",class:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"},null,512),[[V,s.searchQuery]]),t[19]||(t[19]=e("i",{class:"fas fa-search absolute right-3 top-3 text-gray-400"},null,-1))])]),e("div",ke,[e("table",Ie,[t[23]||(t[23]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Nom complet"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Structure"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Email"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Téléphone"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Actions")])],-1)),e("tbody",_e,[(v(!0),p(Q,null,G(s.paginatedTuteurs,r=>{var g,c,x,b,k,_,T,w;return v(),p("tr",{key:r.id,class:"hover:bg-gray-50"},[e("td",Te,d((c=(g=r.user)==null?void 0:g.profile)==null?void 0:c.nom)+" "+d((b=(x=r.user)==null?void 0:x.profile)==null?void 0:b.prenom),1),e("td",Ee,d((k=r.structure)==null?void 0:k.nomStructure),1),e("td",Me,d((_=r.user)==null?void 0:_.email),1),e("td",De,d((w=(T=r.user)==null?void 0:T.profile)==null?void 0:w.telephone),1),e("td",Ce,[e("button",{onClick:E=>s.editTuteur(r),class:"text-primary hover:text-primary-dark",title:"Modifier"},t[20]||(t[20]=[e("i",{class:"fas fa-edit"},null,-1)]),8,Pe),e("button",{onClick:E=>s.deleteTuteur(r.id),class:"text-danger hover:text-red-700",title:"Supprimer"},t[21]||(t[21]=[e("i",{class:"fas fa-trash"},null,-1)]),8,Ve)])])}),128)),s.paginatedTuteurs.length===0?(v(),p("tr",Le,t[22]||(t[22]=[e("td",{colspan:"5",class:"px-6 py-4 text-center text-gray-500"}," Aucun tuteur trouvé ",-1)]))):P("",!0)])])]),e("div",Ae,[(v(!0),p(Q,null,G(s.paginatedTuteurs,r=>{var g,c,x,b,k,_,T,w;return v(),p("div",{key:r.id,class:"bg-white rounded-lg shadow p-4 flex flex-col gap-2"},[e("div",je,[e("span",Ue,d((c=(g=r.user)==null?void 0:g.profile)==null?void 0:c.nom)+" "+d((b=(x=r.user)==null?void 0:x.profile)==null?void 0:b.prenom),1),e("span",ze,d((k=r.structure)==null?void 0:k.nomStructure),1)]),e("div",qe,[t[24]||(t[24]=e("i",{class:"fas fa-envelope mr-1 text-primary"},null,-1)),e("span",null,d((_=r.user)==null?void 0:_.email),1)]),e("div",Oe,[t[25]||(t[25]=e("i",{class:"fas fa-phone mr-1 text-primary"},null,-1)),e("span",null,d((w=(T=r.user)==null?void 0:T.profile)==null?void 0:w.telephone),1)]),e("div",Fe,[e("button",{onClick:E=>s.editTuteur(r),class:"text-primary hover:text-primary-dark",title:"Modifier"},t[26]||(t[26]=[e("i",{class:"fas fa-edit"},null,-1)]),8,Ne),e("button",{onClick:E=>s.deleteTuteur(r.id),class:"text-danger hover:text-red-700",title:"Supprimer"},t[27]||(t[27]=[e("i",{class:"fas fa-trash"},null,-1)]),8,Re)])])}),128)),e("div",Be,[e("button",{onClick:t[2]||(t[2]=r=>s.currentPage--),disabled:s.currentPage===1,class:"relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"}," Précédent ",8,Qe),e("span",Ge,"Page "+d(s.currentPage)+" / "+d(s.totalPages),1),e("button",{onClick:t[3]||(t[3]=r=>s.currentPage++),disabled:s.currentPage===s.totalPages,class:"ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"}," Suivant ",8,Je)])])])])]),s.showAddModal?(v(),p("div",He,[e("div",Ke,[e("div",We,[e("h3",Xe,d(s.editMode?"Modifier":"Ajouter")+" un agent",1)]),e("form",{onSubmit:t[16]||(t[16]=de((...r)=>s.saveTuteur&&s.saveTuteur(...r),["prevent"])),class:"p-4 space-y-3"},[s.errorMessage?(v(),p("div",Ye,d(s.errorMessage),1)):P("",!0),e("div",Ze,[e("div",$e,[e("div",null,[t[28]||(t[28]=e("label",{class:"block text-sm font-medium text-gray-700"},"Nom",-1)),M(e("input",{type:"text","onUpdate:modelValue":t[4]||(t[4]=r=>s.formData.nom=r),required:"",class:"mt-1 input-field"},null,512),[[V,s.formData.nom]])]),e("div",null,[t[29]||(t[29]=e("label",{class:"block text-sm font-medium text-gray-700"},"Prénom",-1)),M(e("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=r=>s.formData.prenom=r),required:"",class:"mt-1 input-field"},null,512),[[V,s.formData.prenom]])])]),e("div",et,[e("div",null,[t[31]||(t[31]=e("label",{class:"block text-sm font-medium text-gray-700"},"Sexe",-1)),M(e("select",{"onUpdate:modelValue":t[6]||(t[6]=r=>s.formData.sexe=r),required:"",class:"mt-1 input-field"},t[30]||(t[30]=[e("option",{value:""},"Sélectionnez",-1),e("option",{value:"M"},"Masculin",-1),e("option",{value:"F"},"Féminin",-1)]),512),[[X,s.formData.sexe]])]),e("div",null,[t[32]||(t[32]=e("label",{class:"block text-sm font-medium text-gray-700"},"Téléphone",-1)),M(e("input",{type:"tel","onUpdate:modelValue":t[7]||(t[7]=r=>s.formData.telephone=r),required:"",class:"mt-1 input-field"},null,512),[[V,s.formData.telephone]])])]),e("div",null,[t[33]||(t[33]=e("label",{class:"block text-sm font-medium text-gray-700"},"Structure",-1)),e("div",tt,[M(e("input",{type:"text","onUpdate:modelValue":t[8]||(t[8]=r=>s.searchStructure=r),onFocus:t[9]||(t[9]=r=>s.showStructuresList=!0),placeholder:"Rechercher une structure...",class:"mt-1 input-field"},null,544),[[V,s.searchStructure]]),s.showStructuresList?(v(),p("div",st,[(v(!0),p(Q,null,G(s.filteredStructures,r=>(v(),p("div",{key:r.id,onClick:g=>s.selectStructure(r),class:"px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"},d(r.nomStructure),9,rt))),128))])):P("",!0)])]),s.selectedStructure&&s.selectedStructure.sousStructures&&s.selectedStructure.sousStructures.length>0?(v(),p("div",ot,[t[35]||(t[35]=e("label",{class:"block text-sm font-medium text-gray-700"},"Sous-structure (optionnel)",-1)),M(e("select",{"onUpdate:modelValue":t[10]||(t[10]=r=>s.formData.sousStructureId=r),class:"mt-1 input-field"},[t[34]||(t[34]=e("option",{value:""},"Sélectionner une sous-structure",-1)),(v(!0),p(Q,null,G(s.selectedStructure.sousStructures,r=>(v(),p("option",{key:r.id,value:r.id},d(r.nomStructure),9,lt))),128))],512),[[X,s.formData.sousStructureId]])])):P("",!0),e("div",at,[e("div",null,[t[36]||(t[36]=e("label",{class:"block text-sm font-medium text-gray-700"},"Email",-1)),M(e("input",{type:"email","onUpdate:modelValue":t[11]||(t[11]=r=>s.formData.email=r),onInput:t[12]||(t[12]=(...r)=>s.validateEmailOnInput&&s.validateEmailOnInput(...r)),required:"",class:Y(["mt-1 input-field",{error:s.emailError}])},null,34),[[V,s.formData.email]]),s.emailError?(v(),p("p",ut,d(s.emailError),1)):P("",!0)]),e("div",null,[t[37]||(t[37]=e("label",{class:"block text-sm font-medium text-gray-700"},"Mot de passe",-1)),M(e("input",{type:"password","onUpdate:modelValue":t[13]||(t[13]=r=>s.formData.password=r),onInput:t[14]||(t[14]=(...r)=>s.validatePasswordOnInput&&s.validatePasswordOnInput(...r)),required:"",class:Y(["mt-1 input-field",{error:s.passwordError}]),placeholder:"Mot de passe"},null,34),[[V,s.formData.password]]),s.passwordError?(v(),p("p",nt,d(s.passwordError),1)):P("",!0)])])]),e("div",it,[e("button",{type:"button",onClick:t[15]||(t[15]=r=>s.showAddModal=!1),class:"btn-outline w-full sm:w-auto"}," Annuler "),e("button",dt,d(s.editMode?"Modifier":"Ajouter"),1)])],32)])])):P("",!0)])}const vt=ne(ve,[["render",ct],["__scopeId","data-v-360f4e0e"]]);export{vt as default};
