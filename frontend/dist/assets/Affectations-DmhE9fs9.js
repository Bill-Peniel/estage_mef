import{_ as K,c as f,o as g,b as e,i as T,t as l,h as U,v as W,F as j,j as V,e as S,n as X,l as Y,m as Z,I as q,f as m,q as h,g as $,G as z}from"./index-C-Ksv_Lv.js";const ee={name:"Affectations",setup(){const I=q(),t=m(!1),P=m(null),s=m(""),p=m([]),_=m([]),r=m(!1),x=m(null),w=m(1),D=15,v=m({structureId:"",tuteurId:""}),k=h(()=>Math.ceil(A.value.length/D)),C=h(()=>(w.value-1)*D),N=h(()=>Math.min(C.value+D,A.value.length)),L=h(()=>A.value.slice(C.value,N.value)),B=h(()=>{const o=[];if(k.value<=5)for(let a=1;a<=k.value;a++)o.push(a);else{let a=Math.max(1,w.value-Math.floor(2.5)),n=a+5-1;n>k.value&&(n=k.value,a=Math.max(1,n-5+1));for(let u=a;u<=n;u++)o.push(u)}return o}),F=h(()=>v.value.structureId?_.value.find(o=>o.id===v.value.structureId):null),A=h(()=>{if(!s.value)return p.value;const o=s.value.toLowerCase();return p.value.filter(d=>{const a=`${d.nom} ${d.prenom}`.toLowerCase(),n=d.email.toLowerCase();return a.includes(o)||n.includes(o)})}),Q=o=>o?new Date(o).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric"}):"Non spécifiée",G=async()=>{try{t.value=!0,P.value=null;const o=await z.get("/stage-request/dpaf");console.log("Réponse complète de l'API:",o.data);const d=o.data.filter(a=>{var n;return console.log("Statut de la demande:",a.status,"pour le stagiaire:",(n=a.stagiaire)==null?void 0:n.email),a.status==="APPROUVE"});console.log("Demandes approuvées:",d),p.value=d.filter(a=>{var u,y,b;const n=(y=(u=a.stagiaire)==null?void 0:u.stagiaire)==null?void 0:y.structureAffecteeId;return console.log("Stagiaire:",(b=a.stagiaire)==null?void 0:b.email,"Structure:",n),!n}).map(a=>{var n,u,y,b,i,c,E,M;return console.log("Traitement du stagiaire:",(n=a.stagiaire)==null?void 0:n.email),{id:(y=(u=a.stagiaire)==null?void 0:u.stagiaire)==null?void 0:y.id,stagiaireId:a.stagiaireId,email:(b=a.stagiaire)==null?void 0:b.email,nom:(c=(i=a.stagiaire)==null?void 0:i.profile)==null?void 0:c.nom,prenom:(M=(E=a.stagiaire)==null?void 0:E.profile)==null?void 0:M.prenom,code_suivi:a.code_suivi,universite:a.universite,departement:a.departement,dateDebut:a.dateDebut}}),console.log("Stagiaires à affecter:",p.value)}catch(o){console.error("Erreur lors du chargement des stagiaires:",o),P.value="Erreur lors du chargement des stagiaires"}finally{t.value=!1}},O=async()=>{try{const o=await z.get("/structures");console.log("Structures reçues:",o.data),_.value=o.data.filter(d=>!d.parentId),console.log("Structures filtrées (structures principales):",_.value)}catch(o){console.error("Erreur lors du chargement des structures:",o),I.error("Erreur lors du chargement des structures")}},J=o=>{x.value=o,v.value={structureId:"",tuteurId:""},r.value=!0},R=()=>{r.value=!1,x.value=null,v.value={structureId:"",tuteurId:""}},H=async()=>{var o,d,a,n,u,y,b;if(!(!x.value||!v.value.structureId))try{t.value=!0;const i=localStorage.getItem("token");if(!i)throw new Error("Non authentifié. Veuillez vous reconnecter.");const c={stagiaireId:x.value.stagiaireId,structureId:Number(v.value.structureId),tuteurId:v.value.tuteurId||null};if(console.log("Token:",i),console.log("Payload envoyé:",JSON.stringify(c,null,2)),(await z.post("/structures/assign-stagiaire",c)).data)p.value=p.value.filter(M=>M.stagiaireId!==x.value.stagiaireId),L.value.length===0&&w.value>1&&(w.value=Math.max(1,w.value-1)),I.success("Stagiaire affecté avec succès"),R(),s.value="";else throw new Error("Réponse invalide du serveur")}catch(i){console.error("Erreur lors de l'affectation:",i),console.error("Détails de l'erreur:",{message:i.message,response:(o=i.response)==null?void 0:o.data,status:(d=i.response)==null?void 0:d.status,headers:(a=i.response)==null?void 0:a.headers,config:i.config});let c="Erreur lors de l'affectation";((n=i.response)==null?void 0:n.status)===404?c="Endpoint non trouvé. Veuillez vérifier que le serveur est bien démarré.":((u=i.response)==null?void 0:u.status)===401?c="Session expirée. Veuillez vous reconnecter.":(b=(y=i.response)==null?void 0:y.data)!=null&&b.message?c=i.response.data.message:i.message&&(c=i.message),I.error(c)}finally{t.value=!1}};return $(()=>{G(),O()}),{loading:t,error:P,searchQuery:s,stagiaires:p,structures:_,showAffectationModal:r,selectedStagiaire:x,selectedStructure:F,affectation:v,filteredStagiaires:A,paginatedStagiaires:L,currentPage:w,totalPages:k,startIndex:C,endIndex:N,displayedPages:B,formatDate:Q,openAffectationModal:J,closeAffectationModal:R,submitAffectation:H}}},te={class:"p-4"},se={key:0,class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"},re={key:1,class:"flex justify-center items-center py-4"},ae={key:2,class:"bg-white rounded-lg shadow"},oe={class:"p-4 border-b"},ne={class:"flex justify-between items-center"},ie={class:"flex items-center space-x-4"},le={class:"overflow-x-auto"},de={class:"min-w-full divide-y divide-gray-200"},ue={class:"bg-white divide-y divide-gray-200"},ce={class:"px-6 py-4 whitespace-nowrap"},fe={class:"text-sm font-medium text-gray-900"},ge={class:"text-xs text-gray-500"},me={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"},pe={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"},xe={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"},ve={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"},ye={class:"px-6 py-4 whitespace-nowrap text-sm font-medium"},be=["onClick"],he={class:"bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6"},we={class:"flex-1 flex justify-between sm:hidden"},_e=["disabled"],ke=["disabled"],Se={class:"hidden sm:flex-1 sm:flex sm:items-center sm:justify-between"},Ie={class:"text-sm text-gray-700"},Pe={class:"font-medium"},Ae={class:"font-medium"},Me={class:"font-medium"},De={class:"relative z-0 inline-flex rounded-md shadow-sm -space-x-px","aria-label":"Pagination"},Ce=["disabled"],Ee=["onClick"],je=["disabled"],Ve={key:3,class:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"},ze={class:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"},Ne={class:"flex justify-between items-center mb-4"},Le=["value"],Re=["value"],Te={class:"flex justify-end space-x-3"},Ue=["disabled"];function Be(I,t,P,s,p,_){return g(),f("div",te,[t[24]||(t[24]=e("h1",{class:"text-2xl text-slate-800 font-bold mb-6 flex justify-center items-center"},"Gestion des Affectations",-1)),s.error?(g(),f("div",se,l(s.error),1)):T("",!0),s.loading?(g(),f("div",re,t[9]||(t[9]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"},null,-1)]))):(g(),f("div",ae,[e("div",oe,[e("div",ne,[e("div",ie,[t[10]||(t[10]=e("i",{class:"fas fa-search border-2 text-slate-800 border-gray-300 rounded-lg p-2"},null,-1)),U(e("input",{type:"text",placeholder:"Rechercher un stagiaire...",class:"px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500","onUpdate:modelValue":t[0]||(t[0]=r=>s.searchQuery=r)},null,512),[[W,s.searchQuery]])])])]),e("div",le,[e("table",de,[t[12]||(t[12]=e("thead",{class:"bg-slate-500"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider"},"Stagiaire"),e("th",{class:"px-6 py-3 text-left text-xs font-medium bg-slate-700 text-white uppercase tracking-wider"},"Email"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider"},"Université"),e("th",{class:"px-6 py-3 text-left text-xs font-medium bg-slate-700 text-white uppercase tracking-wider"},"Département souhaité"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider"},"Date de début"),e("th",{class:"px-6 py-3 text-left text-xs font-medium bg-slate-700 text-white uppercase tracking-wider"},"Actions")])],-1)),e("tbody",ue,[(g(!0),f(j,null,V(s.paginatedStagiaires,r=>(g(),f("tr",{key:r.id,class:"hover:bg-gray-50"},[e("td",ce,[e("div",fe,l(r.nom)+" "+l(r.prenom),1),e("div",ge,"Code: "+l(r.code_suivi),1)]),e("td",me,l(r.email),1),e("td",pe,l(r.universite),1),e("td",xe,l(r.departement),1),e("td",ve,l(s.formatDate(r.dateDebut)),1),e("td",ye,[e("button",{onClick:x=>s.openAffectationModal(r),class:"text-primary hover:text-primary-dark"},t[11]||(t[11]=[e("i",{class:"fas fa-user-plus mr-1"},null,-1),S("Affecter ")]),8,be)])]))),128))])]),e("div",he,[e("div",we,[e("button",{onClick:t[1]||(t[1]=r=>s.currentPage--),disabled:s.currentPage===1,class:"relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Précédent ",8,_e),e("button",{onClick:t[2]||(t[2]=r=>s.currentPage++),disabled:s.currentPage>=s.totalPages,class:"ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Suivant ",8,ke)]),e("div",Se,[e("div",null,[e("p",Ie,[t[13]||(t[13]=S(" Affichage de ")),e("span",Pe,l(s.startIndex+1),1),t[14]||(t[14]=S(" à ")),e("span",Ae,l(s.endIndex),1),t[15]||(t[15]=S(" sur ")),e("span",Me,l(s.filteredStagiaires.length),1),t[16]||(t[16]=S(" résultats "))])]),e("div",null,[e("nav",De,[e("button",{onClick:t[3]||(t[3]=r=>s.currentPage--),disabled:s.currentPage===1,class:"relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[17]||(t[17]=[e("span",{class:"sr-only"},"Précédent",-1),e("i",{class:"fas fa-chevron-left"},null,-1)]),8,Ce),(g(!0),f(j,null,V(s.displayedPages,r=>(g(),f("button",{key:r,onClick:x=>s.currentPage=r,class:X([s.currentPage===r?"z-10 bg-primary border-primary text-white":"bg-white border-gray-300 text-gray-500 hover:bg-gray-50","relative inline-flex items-center px-4 py-2 border text-sm font-medium"])},l(r),11,Ee))),128)),e("button",{onClick:t[4]||(t[4]=r=>s.currentPage++),disabled:s.currentPage>=s.totalPages,class:"relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"},t[18]||(t[18]=[e("span",{class:"sr-only"},"Suivant",-1),e("i",{class:"fas fa-chevron-right"},null,-1)]),8,je)])])])])])])),s.showAffectationModal?(g(),f("div",Ve,[e("div",ze,[e("div",Ne,[t[20]||(t[20]=e("h3",{class:"text-lg font-bold text-gray-900"},"Affecter un stagiaire",-1)),e("button",{onClick:t[5]||(t[5]=(...r)=>s.closeAffectationModal&&s.closeAffectationModal(...r)),class:"text-gray-400 hover:text-gray-500"},t[19]||(t[19]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("form",{onSubmit:t[8]||(t[8]=Y((...r)=>s.submitAffectation&&s.submitAffectation(...r),["prevent"])),class:"space-y-4"},[e("div",null,[t[21]||(t[21]=e("label",{class:"block text-sm font-medium text-gray-700"},"Stagiaire",-1)),e("input",{type:"text",value:s.selectedStagiaire?`${s.selectedStagiaire.nom} ${s.selectedStagiaire.prenom}`:"",disabled:"",class:"mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md"},null,8,Le)]),e("div",null,[t[23]||(t[23]=e("label",{class:"block text-sm font-medium text-gray-700"},"Structure d'accueil",-1)),U(e("select",{"onUpdate:modelValue":t[6]||(t[6]=r=>s.affectation.structureId=r),required:"",class:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"},[t[22]||(t[22]=e("option",{value:""},"Sélectionner une structure",-1)),(g(!0),f(j,null,V(s.structures,r=>(g(),f("option",{key:r.id,value:r.id},l(r.nomStructure),9,Re))),128))],512),[[Z,s.affectation.structureId]])]),e("div",Te,[e("button",{type:"button",onClick:t[7]||(t[7]=(...r)=>s.closeAffectationModal&&s.closeAffectationModal(...r)),class:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"}," Annuler "),e("button",{type:"submit",disabled:s.loading,class:"px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50"},l(s.loading?"Affectation en cours...":"Confirmer l'affectation"),9,Ue)])],32)])])):T("",!0)])}const Qe=K(ee,[["render",Be],["__scopeId","data-v-5f57708d"]]);export{Qe as default};
