import{_ as re,c as v,o as p,b as e,i as L,e as k,h as D,v as C,F as J,j as O,t as c,n as I,l as se,u as oe,f as i,g as ae,p as ne,q as b,R as M}from"./index-C-Ksv_Lv.js";const ue={name:"SousStructures",setup(){const x=oe(),t=i(!1),A=i(!1),r=i(null),S=i(!1),y=i([]),w=i([]),o=i(""),f=i(""),V=i(!1),d=i(""),j=i(1),E=20,U=i(null),N=i({id:null,nomStructure:"",sigle:""}),m=i({nomStructure:"",sigle:"",structureParenteId:null});ae(async()=>{await T(),await B()});const T=async()=>{try{let s=x.state.user;if(!s||!s.structureId){const a=localStorage.getItem("user");a&&(s=JSON.parse(a),x.commit("setUser",s))}return s?!0:(console.error("Aucune donnée utilisateur trouvée"),d.value="Aucune donnée utilisateur trouvée",!1)}catch(s){return console.error("Erreur lors du chargement des données utilisateur:",s),d.value="Erreur lors du chargement des données utilisateur",!1}};ne(o,()=>{j.value=1});const P=b(()=>{const s=o.value.toLowerCase();return y.value.filter(a=>{var h,F,Q,R,G;const n=((h=a.nomStructure)==null?void 0:h.toLowerCase())||"",g=((F=a.adresse)==null?void 0:F.toLowerCase())||"",l=((Q=a.telephone)==null?void 0:Q.toLowerCase())||"",u=((G=(R=a.structureParente)==null?void 0:R.nomStructure)==null?void 0:G.toLowerCase())||"";return n.includes(s)||g.includes(s)||l.includes(s)||u.includes(s)})}),_=b(()=>Math.ceil(P.value.length/E)),z=b(()=>(j.value-1)*E),q=b(()=>{const s=z.value+E;return s>P.value.length?P.value.length:s}),H=b(()=>P.value.slice(z.value,q.value)),K=b(()=>{const s=[];if(_.value<=5)for(let n=1;n<=_.value;n++)s.push(n);else{let n=Math.max(1,j.value-Math.floor(2.5)),g=n+5-1;g>_.value&&(g=_.value,n=Math.max(1,g-5+1));for(let l=n;l<=g;l++)s.push(l)}return s}),W=b(()=>{const s=f.value.toLowerCase();return w.value.filter(a=>!a.isDeleted).filter(a=>a.nomStructure.toLowerCase().includes(s))}),X=s=>{m.value.structureParenteId=s.id,f.value=s.nomStructure,V.value=!1},B=async()=>{try{if(!await T())return;const a=x.state.user;console.log("Données utilisateur:",a);const n=a.structureId;if(console.log("Structure ID de l'utilisateur:",n),!n){console.error("Aucune structure trouvée pour l'utilisateur"),d.value="Aucune structure associée à votre compte";return}const l=(await M.getStructures()).find(u=>u.id===n);if(console.log("Structure récupérée:",l),l){N.value={id:l.id,nomStructure:l.nomStructure,sigle:l.sigle},m.value.structureParenteId=l.id;const u=await M.getSousStructures();console.log("Toutes les sous-structures:",u),y.value=u.filter(h=>h.parentId===n),console.log("Sous-structures filtrées:",y.value)}else{console.error("Structure non trouvée pour l'ID:",n),d.value="Structure non trouvée";return}}catch(s){console.error("Erreur lors du chargement des données:",s),d.value="Erreur lors du chargement des données"}},Y=async()=>{var s,a,n,g,l;try{if(d.value="",console.log("Mode création - Envoi des données:",m.value),!m.value.structureParenteId){d.value="La structure parente est requise";return}const u={nomStructure:m.value.nomStructure,sigle:m.value.sigle,parentId:Number(m.value.structureParenteId),userId:null};if(console.log("Données de sous-structure à envoyer:",u),S.value)await M.updateSousStructure(U.value,u);else{const h=await M.createSousStructure(u);console.log("Réponse création sous-structure:",h)}await B(),t.value=!1,te(),x.dispatch("notification/setSuccess","Sous-structure créée avec succès")}catch(u){console.error("Erreur lors de la création:",u),console.error("Détails de l'erreur:",(s=u.response)==null?void 0:s.data),(n=(a=u.response)==null?void 0:a.data)!=null&&n.message?d.value=Array.isArray(u.response.data.message)?u.response.data.message.join(", "):u.response.data.message:(l=(g=u.response)==null?void 0:g.data)!=null&&l.error?d.value=u.response.data.error:d.value="Une erreur est survenue lors de la sauvegarde de la sous-structure. Veuillez réessayer."}},Z=s=>{var a;S.value=!0,U.value=s.id,m.value={nomStructure:s.nomStructure,sigle:s.sigle,structureParenteId:s.structureParenteId},f.value=((a=s.structureParente)==null?void 0:a.nomStructure)||"",t.value=!0},$=s=>{r.value=s,A.value=!0},ee=async()=>{var s,a;try{await M.deleteSousStructure(r.value.id),y.value=y.value.filter(n=>n.id!==r.value.id),x.dispatch("notification/setSuccess","Sous-structure supprimée avec succès"),A.value=!1,r.value=null}catch(n){console.error("Erreur lors de la suppression de la sous-structure:",n),x.dispatch("notification/setError",((a=(s=n.response)==null?void 0:s.data)==null?void 0:a.message)||"Erreur lors de la suppression")}},te=()=>{var s;S.value=!1,U.value=null,m.value={nomStructure:"",sigle:"",structureParenteId:((s=N.value)==null?void 0:s.id)||null},f.value="",d.value=""};return{showAddModal:t,showDeleteModal:A,structureToDelete:r,editMode:S,sousStructures:y,filteredSousStructures:P,paginatedSousStructures:H,searchQuery:o,currentPage:j,totalPages:_,startIndex:z,endIndex:q,displayedPages:K,formData:m,searchStructure:f,showStructuresList:V,structures:w,filteredStructures:W,selectStructure:X,saveSousStructure:Y,editSousStructure:Z,deleteSousStructure:$,confirmDelete:ee,errorMessage:d,userStructure:N}}},le={class:"min-h-screen bg-gray-100"},ie={class:"flex-1"},de={class:"bg-white shadow"},ce={class:"px-4 py-4 flex justify-between items-center"},me={class:"p-6"},ge={class:"bg-white shadow rounded-lg"},fe={class:"p-4 border-b border-gray-200"},ve={class:"relative"},pe={class:"overflow-x-auto"},xe={class:"min-w-full divide-y divide-gray-200"},ye={class:"bg-white divide-y divide-gray-200"},be={class:"px-6 py-4 whitespace-nowrap"},he={class:"px-6 py-4 whitespace-nowrap"},Se={class:"px-6 py-4 break-words"},we={class:"px-6 py-4 whitespace-nowrap"},Pe={class:"px-6 py-4 whitespace-nowrap text-sm font-medium"},_e=["onClick"],ke=["onClick"],De={key:0},Ce={class:"px-4 py-3 border-t border-gray-200 sm:px-6"},Ie={class:"flex items-center justify-between"},Me={class:"flex-1 flex justify-between sm:hidden"},Ae=["disabled"],Ve=["disabled"],je={class:"hidden sm:flex-1 sm:flex sm:items-center sm:justify-between"},Le={class:"text-sm text-gray-700"},Ee={class:"font-medium"},Ue={class:"font-medium"},Ne={class:"font-medium"},ze={class:"relative z-0 inline-flex rounded-md shadow-sm -space-x-px","aria-label":"Pagination"},Te=["disabled"],qe=["onClick"],Be=["disabled"],Fe={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto"},Qe={class:"bg-white rounded-lg w-full max-w-md my-8"},Re={class:"px-4 py-3 border-b border-gray-200"},Ge={class:"text-lg font-semibold"},Je={key:0,class:"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"},Oe={class:"space-y-3"},He={class:"relative"},Ke={class:"mt-4 flex justify-end space-x-2"},We={type:"submit",class:"btn-primary"},Xe={key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},Ye={class:"bg-white rounded-lg w-full max-w-md p-6"},Ze={class:"text-center"},$e={class:"text-gray-600 mb-6"},et={class:"flex justify-end space-x-3"};function tt(x,t,A,r,S,y){var w;return p(),v("div",le,[e("div",ie,[e("header",de,[e("div",ce,[t[15]||(t[15]=e("h1",{class:"text-2xl font-bold text-primary"},"Gestion des sous-structures",-1)),e("button",{onClick:t[0]||(t[0]=o=>r.showAddModal=!0),class:"bg-primary text-white px-4 py-2 rounded hover:bg-green-900"},t[14]||(t[14]=[e("i",{class:"fas fa-plus mr-2"},null,-1),k(" Ajouter une sous-structure ")]))])]),e("main",me,[e("div",ge,[e("div",fe,[e("div",ve,[D(e("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=o=>r.searchQuery=o),placeholder:"Rechercher une sous-structure...",class:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"},null,512),[[C,r.searchQuery]]),t[16]||(t[16]=e("i",{class:"fas fa-search absolute right-3 top-3 text-gray-400"},null,-1))])]),e("div",pe,[e("table",xe,[t[20]||(t[20]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Nom"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Structure parente"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Adresse"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Téléphone"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Actions")])],-1)),e("tbody",ye,[(p(!0),v(J,null,O(r.paginatedSousStructures,o=>{var f;return p(),v("tr",{key:o.id,class:"hover:bg-gray-50"},[e("td",be,c(o.nomStructure),1),e("td",he,c((f=o.structureParente)==null?void 0:f.nomStructure),1),e("td",Se,c(o.adresse),1),e("td",we,c(o.telephone),1),e("td",Pe,[e("button",{onClick:V=>r.editSousStructure(o),class:"text-primary hover:text-primary-dark mr-3"},t[17]||(t[17]=[e("i",{class:"fas fa-edit"},null,-1)]),8,_e),e("button",{onClick:V=>r.deleteSousStructure(o),class:"text-danger hover:text-red-700"},t[18]||(t[18]=[e("i",{class:"fas fa-trash"},null,-1)]),8,ke)])])}),128)),r.paginatedSousStructures.length===0?(p(),v("tr",De,t[19]||(t[19]=[e("td",{colspan:"5",class:"px-6 py-4 text-center text-gray-500"}," Aucune sous-structure trouvée ",-1)]))):L("",!0)])])]),e("div",Ce,[e("div",Ie,[e("div",Me,[e("button",{onClick:t[2]||(t[2]=o=>r.currentPage--),disabled:r.currentPage===1,class:I(["relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",{"opacity-50 cursor-not-allowed":r.currentPage===1}])}," Précédent ",10,Ae),e("button",{onClick:t[3]||(t[3]=o=>r.currentPage++),disabled:r.currentPage>=r.totalPages,class:I(["ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",{"opacity-50 cursor-not-allowed":r.currentPage>=r.totalPages}])}," Suivant ",10,Ve)]),e("div",je,[e("div",null,[e("p",Le,[t[21]||(t[21]=k(" Affichage de ")),e("span",Ee,c(r.startIndex+1),1),t[22]||(t[22]=k(" à ")),e("span",Ue,c(r.endIndex),1),t[23]||(t[23]=k(" sur ")),e("span",Ne,c(r.filteredSousStructures.length),1),t[24]||(t[24]=k(" résultats "))])]),e("div",null,[e("nav",ze,[e("button",{onClick:t[4]||(t[4]=o=>r.currentPage--),disabled:r.currentPage===1,class:I(["relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50",{"opacity-50 cursor-not-allowed":r.currentPage===1}])},t[25]||(t[25]=[e("span",{class:"sr-only"},"Précédent",-1),e("i",{class:"fas fa-chevron-left"},null,-1)]),10,Te),(p(!0),v(J,null,O(r.displayedPages,o=>(p(),v("button",{key:o,onClick:f=>r.currentPage=o,class:I([r.currentPage===o?"z-10 bg-primary border-primary text-white":"bg-white border-gray-300 text-gray-500 hover:bg-gray-50","relative inline-flex items-center px-4 py-2 border text-sm font-medium"])},c(o),11,qe))),128)),e("button",{onClick:t[5]||(t[5]=o=>r.currentPage++),disabled:r.currentPage>=r.totalPages,class:I(["relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50",{"opacity-50 cursor-not-allowed":r.currentPage>=r.totalPages}])},t[26]||(t[26]=[e("span",{class:"sr-only"},"Suivant",-1),e("i",{class:"fas fa-chevron-right"},null,-1)]),10,Be)])])])])])])])]),r.showAddModal?(p(),v("div",Fe,[e("div",Qe,[e("div",Re,[e("h3",Ge,c(r.editMode?"Modifier":"Ajouter")+" une sous-structure",1)]),e("form",{onSubmit:t[11]||(t[11]=se((...o)=>r.saveSousStructure&&r.saveSousStructure(...o),["prevent"])),class:"p-4"},[r.errorMessage?(p(),v("div",Je,c(r.errorMessage),1)):L("",!0),e("div",Oe,[e("div",null,[t[27]||(t[27]=e("label",{class:"block text-sm font-medium text-gray-700"},"Sigle",-1)),D(e("input",{type:"text","onUpdate:modelValue":t[6]||(t[6]=o=>r.formData.sigle=o),required:"",class:"w-28 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"},null,512),[[C,r.formData.sigle]])]),e("div",null,[t[28]||(t[28]=e("label",{class:"block text-sm font-medium text-gray-700"},"Nom de la sous-structure",-1)),D(e("input",{type:"text","onUpdate:modelValue":t[7]||(t[7]=o=>r.formData.nomStructure=o),required:"",class:"mt-1 input-field"},null,512),[[C,r.formData.nomStructure]])]),e("div",null,[t[29]||(t[29]=e("label",{class:"block text-sm font-medium text-gray-700"},"Structure parente",-1)),e("div",He,[D(e("input",{type:"text","onUpdate:modelValue":t[8]||(t[8]=o=>r.userStructure.nomStructure=o),disabled:"",class:"mt-1 input-field bg-gray-100"},null,512),[[C,r.userStructure.nomStructure]]),D(e("input",{type:"hidden","onUpdate:modelValue":t[9]||(t[9]=o=>r.formData.structureParenteId=o)},null,512),[[C,r.formData.structureParenteId]])])])]),e("div",Ke,[e("button",{type:"button",onClick:t[10]||(t[10]=o=>r.showAddModal=!1),class:"btn-outline"}," Annuler "),e("button",We,c(r.editMode?"Modifier":"Ajouter"),1)])],32)])])):L("",!0),r.showDeleteModal?(p(),v("div",Xe,[e("div",Ye,[e("div",Ze,[t[30]||(t[30]=e("i",{class:"fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"},null,-1)),t[31]||(t[31]=e("h3",{class:"text-lg font-semibold mb-2"},"Confirmer la suppression",-1)),e("p",$e,' Êtes-vous sûr de vouloir supprimer la sous-structure "'+c((w=r.structureToDelete)==null?void 0:w.nomStructure)+'" ? Cette action est irréversible. ',1)]),e("div",et,[e("button",{onClick:t[12]||(t[12]=o=>r.showDeleteModal=!1),class:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"}," Annuler "),e("button",{onClick:t[13]||(t[13]=(...o)=>r.confirmDelete&&r.confirmDelete(...o)),class:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Supprimer ")])])])):L("",!0)])}const st=re(ue,[["render",tt],["__scopeId","data-v-11a84839"]]);export{st as default};
